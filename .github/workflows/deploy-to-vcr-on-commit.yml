name: Deploy to VCR on Commit Push

on:
  push:
    branches-ignore:
      - main
      - develop

permissions:
  contents: write
  pull-requests: write

jobs:
  build-and-test:
    runs-on: [vcp-runner]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3.0.2

      - name: Setup node
        uses: actions/setup-node@v3
        with:
          node-version: 22.4
          cache: npm

      - name: Install VCR CLI
        run: |
          sudo curl -L https://raw.githubusercontent.com/Vonage/cloud-runtime-cli/main/script/install.sh | sudo sh
          vcr -v

      - name: Replace some values in the manifest so that it does not break other deployments and is unique
        run: |
          cp vcr-gha.yml vcr-gha.temp.yml
          SHORT_SHA=$(echo "${GITHUB_SHA}" | cut -c1-7)
          sed -i "s/name: vonage-video-react-app/name: vonage-video-react-app-$SHORT_SHA/g" vcr-gha.temp.yml
          sed -i 's/<DOMAIN>//g' vcr-gha.temp.yml

      - name: Deploy vcr
        id: deploy
        run: |
          vcr deploy --filename vcr-gha.temp.yml --app-id ${{ secrets.APP_ID }} --api-key ${{ secrets.VCR_API_KEY }} --api-secret ${{ secrets.VCR_API_SECRET }} --region aws.euw1 --graphql-endpoint https://graphql.euw1.runtime.vonage.cloud/v1/graphql --timeout=15m 2>&1 | tee deploy-vcr-logs.log
          VCR_URL=$(grep -oE 'https://[a-zA-Z0-9.-]+\.vonage\.cloud' deploy-vcr-logs.log | head -1)
          echo "vcr_url=$VCR_URL" >> $GITHUB_OUTPUT

      - name: Find Pull Request number
        id: find_pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${context.ref.replace('refs/heads/', '')}`,
              state: 'open'
            });
            if (pulls.length > 0) {
              core.setOutput('pr', pulls[0].number);
            }

      - name: Comment the VCR instance link on PR
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ steps.find_pr.outputs.pr }}
          body: |
            ðŸš€ VCR instance deployed for commit `${{ github.sha }}`
            [View VCR Instance](${{ steps.deploy.outputs.vcr_url }})
